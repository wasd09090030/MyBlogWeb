name: Build and Release Nuxt Frontend

on:
  push:
    tags:
      - 'v*.*.*'  # è§¦å‘æ¡ä»¶ï¼šæ¨é€ v å¼€å¤´çš„æ ‡ç­¾ï¼Œå¦‚ v1.0.0
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'
          cache-dependency-path: nuxt/package-lock.json
      
      - name: Install dependencies
        working-directory: ./nuxt
        run: npm ci
      
      - name: Build Nuxt application
        working-directory: ./nuxt
        run: npm run build
      
      - name: Create production archive
        run: |
          cd nuxt
          tar -czf ../nuxt-build.tar.gz .output
          cd ..
      
      - name: Generate build info
        run: |
          echo "Build Date: $(date)" > build-info.txt
          echo "Commit: ${{ github.sha }}" >> build-info.txt
          echo "Tag: ${{ github.ref_name }}" >> build-info.txt
      
      - name: Create Release
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.ref_name }}
          release_name: Release ${{ github.ref_name }}
          draft: false
          prerelease: false
          body: |
            ## ğŸš€ Nuxt Frontend Release ${{ github.ref_name }}
            
            ### ğŸ“¦ æ„å»ºä¿¡æ¯
            - **æ„å»ºæ—¶é—´**: $(date)
            - **Commit**: ${{ github.sha }}
            
            ### ğŸ“¥ ä¸‹è½½è¯´æ˜
            ä¸‹è½½ `nuxt-build.tar.gz` å¹¶è§£å‹åˆ°æœåŠ¡å™¨
            
            ### ğŸ”§ éƒ¨ç½²æ­¥éª¤
            1. è§£å‹æ–‡ä»¶: `tar -xzf nuxt-build.tar.gz`
            2. å®‰è£…ä¾èµ–: `cd .output && npm ci --production`
            3. å¯åŠ¨æœåŠ¡: `node server/index.mjs`
      
      - name: Upload Release Asset
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ./nuxt-build.tar.gz
          asset_name: nuxt-build-${{ github.ref_name }}.tar.gz
          asset_content_type: application/gzip
      
      - name: Upload Build Info
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: ./build-info.txt
          asset_name: build-info.txt
          asset_content_type: text/plain
