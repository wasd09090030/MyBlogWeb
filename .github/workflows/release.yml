name: Build and Release Nuxt Frontend

on:
  push:
    tags:
      - 'v*.*.*'  # è§¦å‘æ¡ä»¶ï¼šæ¨é€ v å¼€å¤´çš„æ ‡ç­¾ï¼Œå¦‚ v1.0.0
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

permissions:
  contents: write  # å…è®¸åˆ›å»º release å’Œä¸Šä¼ æ–‡ä»¶

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'
          cache-dependency-path: nuxt/package-lock.json
      
      - name: Install dependencies
        working-directory: ./nuxt
        run: npm ci
      
      - name: Build Nuxt application
        working-directory: ./nuxt
        run: npm run build
      
      - name: Create production archive
        run: |
          cd nuxt
          tar -czf ../nuxt-build.tar.gz .output
          cd ..
      
      - name: Generate build info
        run: |
          echo "Build Date: $(date)" > build-info.txt
          echo "Commit: ${{ github.sha }}" >> build-info.txt
          echo "Tag: ${{ github.ref_name }}" >> build-info.txt
      
      - name: Create Release and Upload Assets
        uses: softprops/action-gh-release@v1
        with:
          name: Release ${{ github.ref_name }}
          draft: false
          prerelease: false
          body: |
            ## ğŸš€ Nuxt Frontend Project Release ${{ github.ref_name }}
            
            ### ğŸ“¦ æ„å»ºä¿¡æ¯
            - **æ„å»ºæ—¶é—´**: ${{ job.status == 'success' && 'Success' || 'Failed' }}
            - **Commit**: ${{ github.sha }}
            
            ### ğŸ“¥ ä¸‹è½½è¯´æ˜
            ä¸‹è½½ `nuxt-build-${{ github.ref_name }}.tar.gz` å¹¶è§£å‹åˆ°æœåŠ¡å™¨
            
            ### ğŸ”§ éƒ¨ç½²æ­¥éª¤
            1. è§£å‹æ–‡ä»¶: `tar -xzf nuxt-build-${{ github.ref_name }}.tar.gz`
            2. å®‰è£…ä¾èµ–ï¼ˆå¦‚éœ€è¦ï¼‰: `cd .output && npm ci --production`
            3. å¯åŠ¨æœåŠ¡: `node .output/server/index.mjs` æˆ–ä½¿ç”¨ PM2
          files: |
            nuxt-build.tar.gz
            build-info.txt
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
