<template>
  <div class="md-editor-wrapper">
    <!-- MDC ç»„ä»¶å¿«æ·å·¥å…·æ  -->
<<<<<<< HEAD
    <div class="mdc-toolbar bg-gray-50 dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-t-lg p-2 flex items-center gap-2">
      <span class="text-xs font-semibold text-gray-600 dark:text-gray-400 mr-2">MDC ç»„ä»¶:</span>
      <n-button-group size="small">
        <n-button @click="insertTemplate('alert')" quaternary title="æ’å…¥ Alert æç¤ºæ¡†">
          ğŸ’¡ Alert
        </n-button>
        <n-button @click="insertTemplate('tabs')" quaternary title="æ’å…¥ Tabs æ ‡ç­¾é¡µ">
          ğŸ“‘ Tabs
        </n-button>
        <n-button @click="insertTemplate('collapse')" quaternary title="æ’å…¥ Collapse æŠ˜å ">
          ğŸ“¦ Collapse
        </n-button>
        <n-button @click="insertTemplate('codePlayground')" quaternary title="æ’å…¥ä»£ç æ¼”ç¤º">
          ğŸ’» Code
        </n-button>
        <n-button @click="insertTemplate('imageComparison')" quaternary title="æ’å…¥å›¾ç‰‡å¯¹æ¯”">
          ğŸ–¼ï¸ Image
        </n-button>
        <n-button @click="insertTemplate('webEmbed')" quaternary title="æ’å…¥è§†é¢‘åµŒå…¥">
          ğŸ¬ Video
        </n-button>
        <n-button @click="insertTemplate('starRating')" quaternary title="æ’å…¥æ˜Ÿçº§è¯„åˆ†">
          â­ Rating
        </n-button>
      </n-button-group>
=======
    <div class="mdc-toolbar bg-gray-50 dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-t-lg p-2">
      <div class="flex items-center gap-2 flex-wrap">
        <span class="text-xs font-semibold text-gray-600 dark:text-gray-400 mr-2">MDC ç»„ä»¶:</span>
        <n-button-group size="small">
          <n-button @click="insertTemplate('alert')" quaternary title="æ’å…¥ Alert æç¤ºæ¡†">
            ğŸ’¡ Alert
          </n-button>
          <n-button @click="insertTemplate('tabs')" quaternary title="æ’å…¥ Tabs æ ‡ç­¾é¡µ">
            ğŸ“‘ Tabs
          </n-button>
          <n-button @click="insertTemplate('collapse')" quaternary title="æ’å…¥ Collapse æŠ˜å ">
            ğŸ“¦ Collapse
          </n-button>
          <n-button @click="insertTemplate('codePlayground')" quaternary title="æ’å…¥ä»£ç æ¼”ç¤º">
            ğŸ’» Code
          </n-button>
          <n-button @click="insertTemplate('imageComparison')" quaternary title="æ’å…¥å›¾ç‰‡å¯¹æ¯”">
            ğŸ–¼ï¸ Compare
          </n-button>
          <n-button @click="insertTemplate('webEmbed')" quaternary title="æ’å…¥è§†é¢‘åµŒå…¥">
            ğŸ¬ Video
          </n-button>
          <n-button @click="insertTemplate('starRating')" quaternary title="æ’å…¥æ˜Ÿçº§è¯„åˆ†">
            â­ Rating
          </n-button>
        </n-button-group>
        <n-button-group size="small">
          <n-button @click="insertTemplate('steps')" quaternary title="æ’å…¥æ­¥éª¤æ¡">
            ğŸ”¢ Steps
          </n-button>
          <n-button @click="insertTemplate('githubCard')" quaternary title="æ’å…¥ GitHub å¡ç‰‡">
            ğŸ™ GitHub
          </n-button>
          <n-button @click="insertTemplate('imageEnhanced')" quaternary title="æ’å…¥å¢å¼ºå›¾ç‰‡">
            ğŸ¨ Image+
          </n-button>
          <n-button @click="insertTemplate('fileTree')" quaternary title="æ’å…¥æ–‡ä»¶æ ‘">
            ğŸ“ Tree
          </n-button>
        </n-button-group>
      </div>
>>>>>>> 960c065 (mdcåŠŸèƒ½æ¨¡å—æ·»åŠ )
    </div>
    
    <!-- Markdown ç¼–è¾‘å™¨ -->
    <MdEditor
      ref="editorRef"
      v-model="localValue"
      :height="height"
      :toolbars="toolbars"
      preview-theme="github"
      code-theme="github"
      language="zh-CN"
      @on-change="handleChange"
      @on-save="handleSave"
      @on-html-changed="handleHtmlChanged"
      @on-upload-img="handleUploadImg"
      :scroll-auto="true"
      :auto-focus="true"
      :auto-detect-code="true"
      :tab-size="2"
      :table-shape="[6, 4]"
      :show-code-row-number="true"
      :no-mermaid="false"
      :no-katex="false"
      :max-length="100000"
      :auto-save="true"
      placeholder="è¯·è¾“å…¥æ–‡ç« å†…å®¹...æ”¯æŒ Markdown è¯­æ³•ã€HTML æ ‡ç­¾å’Œ MDC ç»„ä»¶"
    />
  </div>
</template>

<script setup>
import { MdEditor, config } from 'md-editor-v3'
import 'md-editor-v3/lib/style.css'

// è®¾ç½®ä¸­æ–‡ç•Œé¢
config({
  editorConfig: {
    languageUserDefined: {
      'zh-CN': {
        toolbarTips: {
          bold: 'åŠ ç²—',
          underline: 'ä¸‹åˆ’çº¿',
          italic: 'æ–œä½“',
          strikeThrough: 'åˆ é™¤çº¿',
          title: 'æ ‡é¢˜',
          sub: 'ä¸‹æ ‡',
          sup: 'ä¸Šæ ‡',
          quote: 'å¼•ç”¨',
          unorderedList: 'æ— åºåˆ—è¡¨',
          orderedList: 'æœ‰åºåˆ—è¡¨',
          task: 'ä»»åŠ¡åˆ—è¡¨',
          codeRow: 'è¡Œå†…ä»£ç ',
          code: 'å—çº§ä»£ç ',
          link: 'é“¾æ¥',
          image: 'å›¾ç‰‡',
          table: 'è¡¨æ ¼',
          mermaid: 'Mermaidå›¾è¡¨',
          katex: 'KaTeXæ•°å­¦å…¬å¼',
          revoke: 'æ’¤é”€',
          next: 'é‡åš',
          save: 'ä¿å­˜',
          prettier: 'ç¾åŒ–ä»£ç ',
          pageFullscreen: 'é¡µé¢å…¨å±',
          fullscreen: 'ç¼–è¾‘å™¨å…¨å±',
          catalog: 'ç›®å½•å¯¼èˆª',
          preview: 'é¢„è§ˆæ¨¡å¼',
          htmlPreview: 'HTMLæºç é¢„è§ˆ'
        },
        titleItem: {
          h1: 'ä¸€çº§æ ‡é¢˜',
          h2: 'äºŒçº§æ ‡é¢˜',
          h3: 'ä¸‰çº§æ ‡é¢˜',
          h4: 'å››çº§æ ‡é¢˜',
          h5: 'äº”çº§æ ‡é¢˜',
          h6: 'å…­çº§æ ‡é¢˜'
        },
        imgTitleItem: {
          link: 'æ·»åŠ é“¾æ¥',
          upload: 'ä¸Šä¼ å›¾ç‰‡',
          clip2upload: 'å‰ªè´´æ¿ä¸Šä¼ '
        },
        linkModalTips: {
          linkTitle: 'æ·»åŠ é“¾æ¥',
          imageTitle: 'æ·»åŠ å›¾ç‰‡',
          descLabel: 'é“¾æ¥æè¿°ï¼š',
          descLabelPlaceHolder: 'è¯·è¾“å…¥æè¿°...',
          urlLabel: 'é“¾æ¥åœ°å€ï¼š',
          urlLabelPlaceHolder: 'è¯·è¾“å…¥é“¾æ¥åœ°å€...',
          buttonOK: 'ç¡®å®š',
          buttonCancel: 'å–æ¶ˆ'
        },
        clipModalTips: {
          title: 'å‰ªè´´æ¿å›¾ç‰‡ä¸Šä¼ ',
          buttonUpload: 'ä¸Šä¼ '
        },
        copyCode: {
          text: 'å¤åˆ¶ä»£ç ',
          successTips: 'å·²å¤åˆ¶ï¼',
          failTips: 'å¤åˆ¶å¤±è´¥ï¼'
        },
        mermaid: {
          flow: 'æµç¨‹å›¾',
          sequence: 'æ—¶åºå›¾',
          gantt: 'ç”˜ç‰¹å›¾',
          class: 'ç±»å›¾',
          state: 'çŠ¶æ€å›¾',
          pie: 'é¥¼å›¾',
          relationship: 'å…³ç³»å›¾',
          journey: 'æ—…ç¨‹å›¾'
        },
        katex: {
          inline: 'è¡Œå†…å…¬å¼',
          block: 'å—çº§å…¬å¼'
        },
        footer: {
          markdownTotal: 'å­—æ•°',
          scrollAuto: 'åŒæ­¥æ»šåŠ¨'
        }
      }
    }
  }
})

const props = defineProps({
  modelValue: {
    type: String,
    default: ''
  },
  height: {
    type: String,
    default: '500px'
  }
})

const emit = defineEmits(['update:modelValue', 'save', 'html-change'])

const editorRef = ref(null)

// æœ¬åœ°çŠ¶æ€ï¼Œè§£å†³ v-model ä¸èƒ½ç›´æ¥ç”¨åœ¨ prop ä¸Šçš„é—®é¢˜
const localValue = ref(props.modelValue)

// ç›‘å¬çˆ¶ç»„ä»¶ä¼ å…¥çš„å€¼å˜åŒ–
watch(() => props.modelValue, (newVal) => {
  if (newVal !== localValue.value) {
    localValue.value = newVal
  }
})

// æ’å…¥ MDC æ¨¡æ¿ â€” ä½¿ç”¨ md-editor-v3 çš„ insert() æš´éœ²æ–¹æ³•åœ¨å…‰æ ‡å¤„æ’å…¥
const insertTemplate = (templateName) => {
  const template = mdcTemplates[templateName]
  if (!template) return

  // md-editor-v3 çš„ ExposeParam.insert æ¥å—ä¸€ä¸ª generator å‡½æ•°
  // generator å‚æ•°ä¸ºå½“å‰é€‰ä¸­æ–‡æœ¬ï¼Œè¿”å› { targetValue, select, deviationStart, deviationEnd }
  if (editorRef.value?.insert) {
    editorRef.value.insert((_selectedText) => {
      return {
        targetValue: '\n\n' + template + '\n\n',
        select: false,
        deviationStart: 0,
        deviationEnd: 0
      }
    })
  } else {
    // é™çº§ï¼šç›´æ¥è¿½åŠ åˆ°æœ«å°¾
    localValue.value += '\n\n' + template
    emit('update:modelValue', localValue.value)
  }
}

// MDC ç»„ä»¶æ¨¡æ¿
const mdcTemplates = {
  alert: `::alert{type="info"}
#title
æç¤ºæ ‡é¢˜
#default
è¿™æ˜¯æç¤ºå†…å®¹ï¼Œæ”¯æŒ **Markdown** æ ¼å¼
::`,
  
  tabs: `::tabs
---
labels: ["é€‰é¡¹å¡ 1", "é€‰é¡¹å¡ 2", "é€‰é¡¹å¡ 3"]
---
#tab-0
ç¬¬ä¸€ä¸ªæ ‡ç­¾é¡µçš„å†…å®¹

#tab-1
ç¬¬äºŒä¸ªæ ‡ç­¾é¡µçš„å†…å®¹

#tab-2
ç¬¬ä¸‰ä¸ªæ ‡ç­¾é¡µçš„å†…å®¹
::`,
  
  collapse: `::collapse{title="ç‚¹å‡»å±•å¼€æ›´å¤šå†…å®¹"}
è¿™é‡Œæ˜¯æŠ˜å çš„å†…å®¹ï¼Œå¯ä»¥åŒ…å«ä»»ä½• Markdown å…ƒç´ 
::`,
  
  codePlayground: `::code-playground{lang="javascript" title="JavaScript ç¤ºä¾‹" editable runnable}
console.log('Hello World!')
const sum = (a, b) => a + b
console.log(sum(2, 3))
::`,
  
  imageComparison: `::image-comparison{before="/img/before.jpg" after="/img/after.jpg" aspectRatio="16/9"}
::`,
  
  webEmbed: `::web-embed{url="https://www.bilibili.com/video/BV1xx411c7mD" aspectRatio="16/9"}
::`,
  
  starRating: `::star-rating{rating="4.5" maxStars="5" label="æ¨èæŒ‡æ•°" showScore}
<<<<<<< HEAD
=======
::`,
  
  steps: `::steps{current="2" status="process" showControls clickable}
---
steps:
  - title: "ç¬¬ä¸€æ­¥"
    description: "æ³¨å†Œè´¦å·"
  - title: "ç¬¬äºŒæ­¥"
    description: "å®Œå–„ä¿¡æ¯"
  - title: "ç¬¬ä¸‰æ­¥"
    description: "å¼€å§‹ä½¿ç”¨"
---
::`,
  
  githubCard: `::github-card{repo="vuejs/core"}
::`,
  
  imageEnhanced: `::image-enhanced{src="/img/photo.jpg" caption="å›¾ç‰‡è¯´æ˜æ–‡å­—" zoomable shadow rounded}
::`,
  
  fileTree: `::file-tree{title="é¡¹ç›®ç»“æ„"}
src/
  components/
    Button.vue
    Input.vue
  pages/
    index.vue
  App.vue
package.json
README.md
>>>>>>> 960c065 (mdcåŠŸèƒ½æ¨¡å—æ·»åŠ )
::`
}

// å®šä¹‰ç¼–è¾‘å™¨å·¥å…·æ 
const toolbars = [
  'bold', 'underline', 'italic', 'strikeThrough',
  '-',
  'title', 'sub', 'sup',
  '-',
  'quote', 'unorderedList', 'orderedList', 'task',
  '-',
  'codeRow', 'code',
  '-',
  'link', 'image', 'table',
  '-',
  'mermaid', 'katex',
  '-',
  'revoke', 'next',
  '-',
  'save', 'prettier',
  '-',
  'pageFullscreen', 'fullscreen', 'preview', 'htmlPreview', 'catalog'
]

const handleChange = (text) => {
  localValue.value = text
  emit('update:modelValue', text)
}

const handleSave = async (text, htmlPromise) => {
  const html = await htmlPromise
  emit('save', text, html)
}

const handleHtmlChanged = (html) => {
  emit('html-change', html)
}

const handleUploadImg = async (files, callback) => {
  try {
    console.log('ä¸Šä¼ å›¾ç‰‡:', files)
    // åˆ›å»ºæœ¬åœ°é¢„è§ˆURL
    const urls = files.map((file) => URL.createObjectURL(file))
    callback(urls)
  } catch (error) {
    console.error('å›¾ç‰‡ä¸Šä¼ å¤±è´¥:', error)
  }
}
</script>

<style>
/* md-editor-v3 æ ·å¼è¦†ç›– */
.md-editor {
  --md-bk-color: var(--n-color) !important;
  border-top-left-radius: 0 !important;
  border-top-right-radius: 0 !important;
}

.md-editor-dark {
  --md-bk-color: #1e1e1e !important;
}

.mdc-toolbar {
  display: flex;
  flex-wrap: wrap;
  align-items: center;
  gap: 0.5rem;
}

@media (max-width: 768px) {
  .mdc-toolbar {
    font-size: 0.75rem;
  }
}
</style>
